services:
  # Frontend Next.js application
  frontend:
    build:
      context: .
      dockerfile: src/Dockerfile
      args:
        NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${NEXT_PUBLIC_GOOGLE_CLIENT_ID:-}
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_GOOGLE_CLIENT_ID=${NEXT_PUBLIC_GOOGLE_CLIENT_ID:-}
      - CIVICPULSE_DB_PATH=/app/backend/db/civicpulse.db
    volumes:
      # Mount backend DB directory for database access (canonical civicpulse.db with documents)
      # Note: Read-write access needed for user authentication (users table)
      - ../backend/db:/app/backend/db
    depends_on:
      - ingestion
      - processing
    networks:
      - civicpulse-network

  # Ingestion module
  ingestion:
    build:
      context: ./src/ingestion
      dockerfile: Dockerfile
    volumes:
      # Mount backend directories for data and schema (configs are now in the image)
      - ../backend/data:/app/backend/data
      - ../backend/db:/app/backend/db:ro
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - civicpulse-network
    restart: unless-stopped

  # Processing module
  processing:
    build:
      context: ./src/processing
      dockerfile: Dockerfile
    volumes:
      # Mount backend directories for processing input/output
      - ../backend/processing:/app/backend/processing
      - ../backend/data:/app/backend/data
      - ../backend/db:/app/backend/db:ro
    environment:
      - PYTHONUNBUFFERED=1
      - CIVICPULSE_KEYWORDS=${CIVICPULSE_KEYWORDS:-}
    networks:
      - civicpulse-network
    restart: unless-stopped

  # LLM metadata parser
  lm-parser:
    build:
      context: ./src/lm_parser
      dockerfile: Dockerfile
    volumes:
      - ../backend/processing:/app/backend/processing
      - ../backend/data:/app/backend/data
      - ../backend/db:/app/backend/db
      - ../secrets/google_api_key.txt:/run/secrets/google_api_key.txt:ro
    environment:
      - PYTHONUNBUFFERED=1
      - GOOGLE_API_KEY_PATH=/run/secrets/google_api_key.txt
      - CIVICPULSE_DB_PATH=/app/backend/db/civicpulse.db
    depends_on:
      processing:
        condition: service_started
    networks:
      - civicpulse-network
    restart: unless-stopped

networks:
  civicpulse-network:
    driver: bridge

volumes:
  backend-data:
  backend-configs:
  backend-db:

