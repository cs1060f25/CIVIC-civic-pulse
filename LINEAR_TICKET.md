# Deploy Production Database and Complete CI/CD Pipeline

## Summary
Set up production database access for Kubernetes deployment and complete the CI/CD pipeline to automatically build, deploy, and restart services on merge to main.

## Problem
- Production Kubernetes deployment had an empty database, preventing documents from appearing in the search interface
- CI/CD pipeline was incomplete - missing deployment restart steps after Pulumi updates
- README lacked production deployment link

## Solution

### Database Setup
1. **Database Initialization Job** (`infrastructure/init-db-job.yaml`)
   - Created Kubernetes Job to initialize SQLite database with schema
   - Ensures database tables exist before frontend starts

2. **Database Migration** (`infrastructure/copy-db-pod.yaml`)
   - Created temporary pod to copy local database file to Kubernetes persistent volume
   - Migrated 1.4MB database with 21 documents to production environment
   - Verified database accessibility by frontend pods

### CI/CD Pipeline Updates (`.github/workflows/deploy.yml`)
1. **Fixed Frontend Build Context**
   - Corrected build context from `civicpulse/src` to `civicpulse` with Dockerfile path `src/Dockerfile`
   - Matches local build script configuration

2. **Added Deployment Restart Steps**
   - Get namespace from Pulumi outputs
   - Configure kubectl to connect to GKE cluster
   - Restart all deployments (frontend, ingestion, processing, lm-parser) after Pulumi deployment
   - Wait for rollouts to complete with appropriate timeouts
   - Ensures new images are pulled and services are restarted after infrastructure updates

### Documentation Updates (`README.md`)
- Added production deployment link at the top: `**üåê Live Site:** [https://civicpulse.dev](https://civicpulse.dev)`

## Technical Details

### Files Changed
- `.github/workflows/deploy.yml` - Added deployment restart and rollout status steps
- `README.md` - Added production URL link
- `infrastructure/init-db-job.yaml` - New file for database initialization
- `infrastructure/copy-db-job.yaml` - New file for database copying (temporary)
- `infrastructure/copy-db-pod.yaml` - New file for database migration (temporary)

### Infrastructure Changes
- Database now properly initialized in Kubernetes persistent volume
- All 21 documents accessible in production
- CI/CD pipeline now fully automated from merge to deployment

## Testing
- ‚úÖ Verified database file exists in Kubernetes PVC (1.4MB)
- ‚úÖ Confirmed frontend can connect to database
- ‚úÖ Tested API endpoint returns 21 documents
- ‚úÖ Verified documents appear in search interface at https://civicpulse.dev

## Deployment Notes
- Database migration was a one-time operation
- Future deployments will use the existing persistent volume
- CI/CD pipeline will automatically restart services on each merge to main

## Related
- Production deployment: https://civicpulse.dev
- Kubernetes namespace: `civicpulse-104c2bda` (dynamically generated by Pulumi)

## Acceptance Criteria
- [x] Database initialized in Kubernetes
- [x] Documents accessible in production
- [x] CI/CD pipeline includes deployment restart
- [x] README updated with production link
- [x] All services restart after Pulumi deployment

